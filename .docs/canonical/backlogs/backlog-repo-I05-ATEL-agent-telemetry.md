---
type: backlog
endeavor: repo
initiative: I05-ATEL
initiative_name: agent-telemetry
status: active
updated: 2026-02-17
---

# Backlog: Agent Telemetry

Single continuous queue of **changes** (smallest independently valuable increments). Ordered by roadmap outcome and dependency. Implementers pull from here; execution is planned in the plan doc.

## Changes (ranked)

Full ID prefix for this initiative: **I05-ATEL**. In-doc shorthand: B1, B2, ... Cross-doc or reports: use I05-ATEL-B01, I05-ATEL-B02, etc.

| ID | Change | Roadmap outcome | Value | Status |
|----|--------|-----------------|-------|--------|
| B1 | Scaffold Tinybird TS project at `telemetry/` in repo root. **Config:** package.json (scripts: test, test:unit, test:unit:watch, test:integration, test:coverage, type-check, lint, lint:fix, format, format:fix, build, prepare: "husky", tinybird:dev, tinybird:build, tinybird:deploy), tsconfig.json (strict: true, target/module ES2022, moduleResolution bundler, noUnusedLocals, noUnusedParameters, noImplicitReturns, noFallthroughCasesInSwitch, noUncheckedIndexedAccess, isolatedModules, skipLibCheck, forceConsistentCasingInFileNames; exclude node_modules/dist/coverage), tsconfig.eslint.json (extends tsconfig, includes src + tests + *.config.ts), .nvmrc (Node 22), tinybird.json. **Test infra:** vitest.shared.config.ts (path aliases from tsconfig, v8 coverage provider, globals: true, env: node), vitest.unit.config.ts (include src/**/*.test.ts), vitest.integration.config.ts (include tests/integration/**/*.test.ts, dotenv for .env.test), tests/mocks/server.ts + tests/setup-msw.ts (MSW v2). **Lint/format:** eslint.config.ts (flat config: @eslint/js + typescript-eslint strictTypeChecked + sonarjs + eslint-config-prettier + simple-import-sort; rules: no-explicit-any error, no-unsafe-* error, no-floating-promises error, no-unused-vars error with _prefix ignore; test file relaxations for no-unsafe-* and no-unnecessary-condition; ignores: dist, node_modules, coverage), prettier.config.ts (singleQuote: true, trailingComma: 'es5', semi: true, printWidth: 100, tabWidth: 2), .prettierignore (node_modules, dist, coverage, pnpm-lock.yaml, .tinyb). **Env:** .env.example (TB_INGEST_TOKEN, TB_READ_TOKEN, TB_HOST placeholders), .gitignore (.env*, node_modules/, coverage/, dist/, .tinyb, .DS_Store, *.tsbuildinfo). **Seed:** src/index.ts (empty barrel export). **Validation:** `pnpm install && pnpm type-check && pnpm lint && pnpm format && pnpm test:unit` all exit 0 on empty scaffold | 1 | Unblocks all datasource, pipe, client, and hook work | done |
| B2 | Add Phase 0 quality gate (must pass before any feature work). **Husky:** `.husky/pre-commit` runs `pnpx lint-staged --verbose`. **lint-staged:** lint-staged.config.ts with: `'**/*.ts'` → [() => 'pnpm type-check' (full project, no file args), 'pnpm lint:fix', 'pnpm format:fix'], `'**/*.{md,json,yaml,yml}'` → 'pnpm format:fix', `'{src,tests}/**/*.ts'` → () => ['pnpm test:unit']. **Audit:** `pnpm tinybird:build` validates datasource/pipe definitions (manual, not pre-commit). **Validation:** (1) Stage a .ts file with `const x: any = 1` → pre-commit rejects (type-check fails), (2) stage a .ts file with `var x = 1` → pre-commit rejects (lint fails), (3) stage a valid .ts file → pre-commit passes with type-check + lint + format + test output, (4) `pnpm tinybird:build` exits 0 | 1 | No feature work until gate passes; enforces TDD | done |
| B3 | Create CI + deploy pipelines. **CI** (`.github/workflows/telemetry-ci.yml`): triggers on push/PR with path filter (`telemetry/**`, workflow file itself); concurrency group per branch (cancel-in-progress: true); 2 jobs: (1) `checks` — checkout, pnpm setup (explicit version), Node setup (node-version-file: .nvmrc, cache: pnpm), `pnpm install --frozen-lockfile`, `pnpm format`, `pnpm lint`, `pnpm type-check`, `npx tinybird build --dry-run` (with placeholder TB_TOKEN/TB_HOST so config resolves; no push); (2) `unit-tests` — same setup, `pnpm test:unit`. Actions use version tags (e.g. @v4, @v2). Integration test job with Tinybird local service container added when B21 completes. **Deploy** (`.github/workflows/telemetry-deploy.yml`): workflow_dispatch only; requires `TB_HOST` + `TB_TOKEN` repository secrets; steps: checkout, pnpm/Node setup, install, `npx tinybird build`, `npx tinybird deploy --dry-run`, `npx tinybird deploy`. **Validation:** push branch touching `telemetry/` → CI triggers with both jobs green; deploy workflow visible in Actions tab with manual trigger button | 1 | Quality gate enforced in CI; deployment via pipeline only | done |
| B4 | Define `agent_activations` datasource + unit test. Schema: timestamp DateTime, session_id String, parent_session_id Nullable(String), agent_type LowCardinality(String), agent_id String, event LowCardinality(String), input_tokens UInt64, output_tokens UInt64, cache_read_tokens UInt64, cache_creation_tokens UInt64, duration_ms UInt64, model LowCardinality(String), est_cost_usd Float64, success UInt8, error_type LowCardinality(Nullable(String)), tool_calls_count UInt32. Sorting key: (agent_type, model, toStartOfHour(timestamp), session_id). TTL: 180 days | 2 | Core datasource for agent tracking; unblocks agent_usage_summary pipe | done |
| B5 | Define `skill_activations` datasource + unit test. Schema: timestamp DateTime, session_id String, skill_name LowCardinality(String), entity_type LowCardinality(String) (values: skill, command), agent_type LowCardinality(Nullable(String)), duration_ms UInt64, success UInt8. Sorting key: (skill_name, toStartOfHour(timestamp), session_id). TTL: 180 days | 2 | Core datasource for skill/command tracking; unblocks skill_frequency pipe | done |
| B6 | Define `api_requests` datasource + unit test. Schema: timestamp DateTime, session_id String, model LowCardinality(String), input_tokens UInt64, output_tokens UInt64, cache_read_tokens UInt64, cache_creation_tokens UInt64, cost_usd Float64, duration_ms UInt64, status_code UInt16, error_type LowCardinality(Nullable(String)), source LowCardinality(String). Sorting key: (model, toStartOfHour(timestamp), session_id). TTL: 90 days | 2 | Core datasource for cost tracking; unblocks cost_by_model pipe | done |
| B7 | Define `session_summaries` datasource + unit test. Schema: timestamp DateTime, session_id String, total_duration_ms UInt64, agent_count UInt32, skill_count UInt32, api_request_count UInt32, total_input_tokens UInt64, total_output_tokens UInt64, total_cache_read_tokens UInt64, total_cost_usd Float64, agents_used Array(String), skills_used Array(String), model_primary LowCardinality(String). Sorting key: (toStartOfDay(timestamp), session_id). TTL: 365 days | 2 | Session-level aggregates; unblocks session_overview pipe and session-summary hook | done |
| B8 | Define `telemetry_health` datasource + unit test. Schema: timestamp DateTime, hook_name LowCardinality(String), exit_code UInt8, duration_ms UInt64, error_message Nullable(String), tinybird_status_code Nullable(UInt16). Sorting key: (hook_name, toStartOfHour(timestamp)). TTL: 90 days | 2 | Self-observability; detects silent hook failures and ingestion errors | done |
| B9 | Create src/datasources/index.ts barrel export (all 6 datasources). No dedicated test required -- validated by type-check and downstream consumer tests (B19, B21) | 2 | Clean import surface for pipes and client | done |
| B10 | Configure native OTel environment variables for Tinybird OTLP endpoint. MUST use HTTPS. Document required env vars (CLAUDE_CODE_ENABLE_TELEMETRY, OTEL_EXPORTER_OTLP_ENDPOINT, OTEL_LOG_TOOL_DETAILS). Add validation that endpoint starts with https:// | 7 | Enables zero-code standard metrics ingestion (parallel OTel track) | done |
| B11 | Define `agent_usage_summary` pipe + unit test. Params: days Int32 (default 7). Output: agent_type, invocations, total_input, total_output, total_cache_read, avg_duration_ms, est_cost_usd, failure_count, error_rate. Queries agent_activations WHERE event='stop' | 3 | Primary agent analytics endpoint; drives optimization hints | done |
| B12 | Define `skill_frequency` pipe + unit test. Params: days Int32 (default 7). Output: skill_name, entity_type, activations, successes, avg_duration_ms | 3 | Skill/command usage visibility; identifies underused/overused | done |
| B13 | Define `cost_by_model` pipe + unit test. Params: days Int32 (default 7). Output: model, total_input, total_output, total_cost_usd, request_count, error_count, error_rate | 3 | Cost attribution by model; budget monitoring | done |
| B14 | Define `session_overview` pipe + unit test. Params: session_id String (optional), days Int32 (default 7). Output: session_id, agents_used, skills_used, total_tokens, total_cost_usd, total_duration_ms | 3 | Per-session drill-down; debugging and auditing | done |
| B15 | Define `optimization_insights` pipe + unit test. Params: days Int32 (default 7). Output: agent_type, avg_cost_per_invocation, avg_tokens, frequency, cache_ratio, efficiency_score. Formula: efficiency_score = (total_cache_read / total_tokens) * ln(invocations + 1) | 3 | Actionable optimization recommendations with defined scoring | done |
| B16 | Define `telemetry_health_summary` pipe + unit test. Params: hours Int32 (default 24). Output: hook_name, total_invocations, failures, failure_rate, avg_duration_ms, last_error | 3 | Self-observability; surfaces hook failures and ingestion issues | done |
| B17 | Create src/pipes/index.ts barrel export (all 7 pipes). No dedicated test required -- validated by type-check and downstream consumer tests (B19, B21) | 3 | Clean import surface for client | done |
| B18 | Document OTel setup in `.docs/canonical/ops/ops-repo-otel-setup.md`: environment variables, HTTPS verification, troubleshooting, Tinybird OTLP endpoint configuration | 7 | Onboarding and troubleshooting reference (parallel OTel track) | done |
| B19 | Create src/client.ts (createTelemetryClient with separate read token and ingest token configuration, wiring all datasources + pipes) + unit test with msw mocks. Test error paths: 401, 429, 500, network timeout, malformed response, empty results | 4 | Single entry point for all telemetry operations with proper token separation | done |
| B20 | Create tests/integration/helpers/factories.ts: makeAgentActivationRow, makeSkillActivationRow, makeApiRequestRow, makeSessionSummaryRow, makeTelemetryHealthRow + batch helpers (plural variants). All factories typed against datasource InferRow types | 4 | Test data factories; unblocks integration tests | done |
| B21 | Create integration tests for ALL pipes against Tinybird local: agent_usage_summary, skill_frequency, cost_by_model, session_overview, optimization_insights, telemetry_health_summary + cross-endpoint consistency test (session totals match cost_by_model totals) + parameter validation tests (negative days, zero, large values, missing session_id) | 4 | End-to-end validation of datasource-to-pipe pipeline | done |
| B22 | Verify standard OTel metrics (token.usage, cost.usage, tool_result) flowing to Tinybird. Confirm session_id availability as OTel resource attribute for cross-path correlation. **BLOCKED**: OTLP/protobuf vs Tinybird NDJSON protocol mismatch — needs empirical verification and decision gate. See `.docs/reports/researcher-260217-otel-tinybird-validation-b22.md` | 7 | OTel data path validated (parallel OTel track) | blocked |
| B23 | Hook event validation spike: validate SubagentStart/SubagentStop payloads (confirm agent_type, agent_id, agent_transcript_path available), validate PostToolUse data (confirm tool_name and input accessible for path filtering), validate SessionStart/SessionEnd payloads, validate session_id availability across all events. Document findings. See `.docs/reports/researcher-260217-hook-event-validation-spike.md` | 5 | De-risks hook implementation; prevents Wave 5-6 rework | done |
| B24 | Document JSONL transcript schema: capture sample transcripts from real sessions, define Zod schema for transcript rows, create test fixtures (valid, empty, malformed, no-token-fields, large). Build `parseTranscriptTokens(content: string)` module with strict field allowlist (only token count fields, never content) + unit test | 5 | Prerequisite for B27; ensures safe transcript parsing | done |
| B25 | Create `.claude/hooks/` directory. Resolve settings file (`.claude/settings.local.json` per existing convention) | 5 | Unblocks hook wrapper creation | done |
| B26 | Create `src/hooks/parse-agent-start.ts` + unit test. Input: SubagentStart event JSON. Output: partial AgentActivationRow with event=start. Validates input fields | 5 | Testable core logic for agent start hook | done |
| B27 | Create `src/hooks/parse-agent-stop.ts` + unit test. Input: SubagentStop event JSON + JSONL transcript content. Output: AgentActivationRow with token counts, cost, duration. Uses parseTranscriptTokens from B24. Tests: valid transcript, empty file, malformed JSONL, missing fields, no content leakage | 5 | Testable core logic for agent stop hook; most complex hook | done |
| B28 | Create `src/hooks/parse-skill-activation.ts` + unit test. Input: PostToolUse event JSON. Output: SkillActivationRow. Filters for paths matching skills/**/SKILL.md or commands/**/*.md; determines entity_type (skill vs command) | 5 | Testable core logic for skill/command activation hook | done |
| B29 | Create `src/hooks/build-session-summary.ts` + unit test. Input: SessionEnd event JSON + session transcript JSONL. Output: SessionSummaryRow with aggregated counts (agent count, skill count, total tokens, cost). Parses transcript for agent/skill activity | 5 | Testable core logic for session summary hook | done |
| B30 | Create `src/hooks/build-usage-context.ts` + unit test. Input: AgentUsageSummaryRow[]. Output: validated additionalContext JSON. Strict response validation: allowlist of field names and value types, drop unexpected keys, reject instruction-like content. Limit to top-5 agents + top-3 hints. Test: valid input, empty input, malformed input, oversized input, injection attempt | 5 | Testable core logic for feedback loop; includes security validation | done |
| B31 | Create 5 pre-compiled JS entry-point wrappers under `.claude/hooks/`: log-agent-start.js, log-agent-stop.js, log-skill-activation.js, log-session-summary.js, inject-usage-context.js. Each reads stdin, calls core logic module, handles errors by logging to telemetry_health (never blocks). inject-usage-context.js includes 2s timeout + cache fallback to ~/.cache/agents-and-skills/usage-context.json | 6 | Thin wrappers connecting Claude Code hooks to tested core logic | done |
| B32 | Update `.claude/settings.local.json` with all hook definitions: SubagentStart, SubagentStop, PostToolUse (with path-based matcher), SessionEnd (all async), SessionStart (returns additionalContext) | 6 | Activates all hook scripts | done |
| B33 | E2E verification with specific pass/fail checklist: (1) Trigger SubagentStart -> verify agent_activations row with event=start via agent_usage_summary, (2) Trigger SubagentStop -> verify token counts from transcript in agent_activations with event=stop, (3) Trigger PostToolUse on SKILL.md read -> verify skill_activations row via skill_frequency, (4) Trigger SessionEnd -> verify session_summaries row via session_overview, (5) Start new session -> verify inject-usage-context returns non-empty additionalContext with expected fields, (6) Verify OTel metrics via native path, (7) Verify telemetry_health has no unresolved failures, (8) Data visible within 60 seconds of hook fire. Define timeout expectations | 6 | Full system validated before production deploy | done |
| B34 | Update CLAUDE.md "Working with AI Agents" section with "Telemetry-Informed Agent Selection" guidance: mandatory agents (tdd-reviewer, ts-enforcer, refactor-assessor) remain mandatory regardless of cost data; telemetry context informs optional agent engagement only; never cite telemetry as reason to skip quality gates | 8 | Ensures feedback loop does not undermine quality mandates | todo |
| B35 | Update `.docs/AGENTS.md` with I05-ATEL initiative references, learnings (L23: telemetry context is advisory not prescriptive; L24: agent name field is now a stable telemetry identifier -- renames fragment historical data) | 8 | Operating reference current; agent name stability documented | todo |
| B36 | Tinybird deploy to production via `.github/workflows/telemetry-deploy.yml` (workflow_dispatch trigger; runs tinybird build → deploy --dry-run → deploy). **Validation:** deploy workflow completes successfully; pipe endpoints return data from Tinybird production | 8 | Telemetry system live | todo |
| B37 | Create `agent-cost-optimization` skill at `skills/agent-development-team/agent-cost-optimization/SKILL.md`. Framework for analyzing telemetry data to tune agent/skill configurations. **Covers:** model tier selection guidelines (when to use haiku vs. sonnet vs. opus per agent based on task complexity vs. cost), token budget patterns, cache optimization strategies, cost-per-task benchmarks. References I05-ATEL pipe outputs: `optimization_insights` (B15), `cost_by_model` (B13), `agent_usage_summary` (B11). Wire to relevant agents (e.g. `product-director`, `architect`) via frontmatter `related-skills`. Add to `skills/README.md`. **Validation:** SKILL.md exists, indexed in skills/README.md, at least one agent references it. **Source:** [Gap analysis report](../../reports/report-repo-productagent-pm-skills-gap-analysis-20260217.md) recommendation #3 | 9 | Bridges gap between I05-ATEL data collection and cost-model reasoning; enables data-driven agent tuning decisions | todo |
| B38 | Create `telemetry-analysis` skill at `skills/engineering-team/telemetry-analysis/SKILL.md`. Patterns for interpreting I05-ATEL analytics pipes. **Covers:** what "good" looks like for each metric (agent_usage_summary, skill_frequency, cost_by_model, session_overview, optimization_insights), threshold-based alerting logic, trend analysis patterns, efficiency score interpretation. References all I05-ATEL pipe definitions. Wire to relevant agents (e.g. `observability-engineer`, `product-director`) via frontmatter `related-skills`. Add to `skills/README.md`. **Validation:** SKILL.md exists, indexed in skills/README.md, at least one agent references it. **Source:** [Gap analysis report](../../reports/report-repo-productagent-pm-skills-gap-analysis-20260217.md) recommendation #3 | 9 | Turns raw telemetry data into actionable intelligence; defines what healthy telemetry looks like | todo |

## Parallelization strategy

**Wave 1**: B1 then B2 then B3 (sequential -- scaffold, quality gate, CI)
**Wave 2**: B4, B5, B6, B7, B8 in parallel + B10 in parallel (datasources + OTel config)
**Wave 3**: B9 then B11, B12, B13, B14, B15, B16 in parallel + B17 + B18 in parallel (barrel then pipes + OTel docs)
**Wave 4**: B19, B20, B21 (client depends on B9/B17; factories + integration tests follow) + B22 in parallel
**Wave 5**: B23 first (spike), then B24, B25, then B26, B27, B28, B29, B30 in parallel
**Wave 6**: B31, B32, B33 (sequential -- wrappers, config, then E2E)
**Wave 7**: B34, B35, B36 in parallel
**Wave 8**: B37, B38 in parallel (requires Wave 7 complete — skills reference production pipe outputs)

## Backlog item lens (per charter)

- **Roadmap outcome:** Listed in table.
- **Value/impact:** Enables next outcome or unblocks other changes.
- **Design/UX:** N/A (internal tooling).
- **Engineering:** Tinybird TS SDK datasource/pipe definitions, hook TypeScript core logic modules with co-located tests, pre-compiled JS entry-point wrappers, OTel configuration. TDD with co-located tests. TypeScript strict mode.
- **Security/privacy:** Separate read/write Tinybird tokens; transcript field allowlist (never read content); response validation on SessionStart hook; .env files never committed; HTTPS enforced for all data transmission; hook scripts fail explicitly on missing credentials.
- **Observability:** telemetry_health datasource and telemetry_health_summary pipe provide self-observability. Hooks log failures. Informal SLIs: ingestion completeness >95%, hook reliability >99%, feedback latency <2s.
- **Rollback:** Remove hook entries from .claude/settings.local.json; unset CLAUDE_CODE_ENABLE_TELEMETRY. Immediate and reversible.
- **Acceptance criteria:** Per roadmap outcome checkpoints; individual item descriptions include specific schemas, sorting keys, TTLs, and test scenarios.
- **Definition of done:** Tests pass (unit + integration where applicable), type-check clean, lint clean, format clean, Tinybird build succeeds, CI green, pre-commit hook passes. See roadmap "Outcome validation" section for per-outcome verification commands.

## Links

- Charter: [charter-repo-agent-telemetry.md](../charters/charter-repo-agent-telemetry.md)
- Roadmap: [roadmap-repo-I05-ATEL-agent-telemetry-2026.md](../roadmaps/roadmap-repo-I05-ATEL-agent-telemetry-2026.md)
